FROM youken9980/ubuntu:jammy
LABEL maintainer="YangJian <youken9980@163.com>"

# https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.6%2B10/OpenJDK17U-jre_x64_linux_hotspot_17.0.6_10.tar.gz

ENV JAVA_HOME="/opt/java/openjdk"
ENV PATH=".:$PATH:$JAVA_HOME/bin"
# Default to UTF-8 file.encoding
ENV LANG='zh_CN.UTF-8' LANGUAGE='zh_CN:zh' LC_ALL='zh_CN.UTF-8'

RUN set -eux && \
    jdkMajor="17" && \
    jdkVersion="${jdkMajor}.0.6" && \
    suffix="10" && \
    \
    apt-get update && \
    DEBIAN_FRONTEND="noninteractive" && \
    apt-get install -y --no-install-recommends fontconfig locales binutils axel && \
    echo "zh_CN.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen en_US.UTF-8 zh_CN.UTF-8 && \
    echo "locales locales/default_environment_locale select zh_CN.UTF-8" | debconf-set-selections && \
    echo "locales locales/locales_to_be_generated multiselect zh_CN.UTF-8 UTF-8" | debconf-set-selections && \
    dpkg-reconfigure --frontend noninteractive locales && \
    fc-cache -f && \
    \
    axel -o /tmp/openjdk.tar.gz https://ghproxy.com/https://github.com/adoptium/temurin${jdkMajor}-binaries/releases/download/jdk-${jdkVersion}%2B${suffix}/OpenJDK${jdkMajor}U-jre_x64_linux_hotspot_${jdkVersion}_${suffix}.tar.gz && \
    axel -o /tmp/openjdk.tar.gz.sha256.txt https://ghproxy.com/https://github.com/adoptium/temurin${jdkMajor}-binaries/releases/download/jdk-${jdkVersion}%2B${suffix}/OpenJDK${jdkMajor}U-jre_x64_linux_hotspot_${jdkVersion}_${suffix}.tar.gz.sha256.txt && \
    echo "$(cat /tmp/openjdk.tar.gz.sha256.txt | awk '{ print $1 }') */tmp/openjdk.tar.gz" | sha256sum -c - && \
    mkdir -p ${JAVA_HOME} && \
    tar -zxvf /tmp/openjdk.tar.gz -C ${JAVA_HOME} --strip-components=1 --no-same-owner && \
    \
    # https://github.com/docker-library/openjdk/issues/331#issuecomment-498834472
    find "$JAVA_HOME/lib" -name '*.so' -exec dirname '{}' ';' | sort -u > /etc/ld.so.conf.d/docker-openjdk.conf && \
    ldconfig && \
    # https://github.com/docker-library/openjdk/issues/212#issuecomment-420979840
    # https://openjdk.java.net/jeps/341
    java -Xshare:dump && \
    \
    echo "Verifying install ..." && \
    echo "java --version" && java --version && \
    echo "Complete." && \
    \
    \
    rm -rf /var/lib/apt/lists/* \
           /var/cache/* \
           /tmp/* \
           ${JAVA_HOME}/src.zip
